{% extends "display/base.html" %}

{% block title %}
    Allen Brain
{% endblock %}

{% block dependencies %}
    <link rel="stylesheet" type="text/css"
          href="//cdn.datatables.net/1.10.20/css/jquery.dataTables.min.css"/>
{% endblock %}

{% block content %}
    <p>
        We can also use <a href="https://connectivity.brain-map.org/projection">
        Allen Brain Atlas website</a> to get the data for experiments. Format
        <em>.xml</em> (experiment) or <em>.csv</em> (experiments container).
    </p>

    <div class="table table-sm bg-light">
        <div class="filter-exp">
            <h3>Experiments filters</h3>
            <button class="btn btn-info" data-toggle="collapse" data-target="#hemisphere">
                hemisphere
            </button>
            <div id="hemisphere" class="collapse">
                <!--
                //https://datatables.net/reference/api/unique()
                //https://www.w3schools.com/TAGS/tryit.asp?filename=tryhtml_select_multiple
                //https://www.w3schools.com/howto/howto_js_autocomplete.asp
                -->
                <hr/>
                <label class="form-check-label" for="name"><strong>name: </strong></label>
                <input type="text" id="name" name="name[]" aria-describedby="name-help"/>
                <small id="name-help" class="text-muted">must be exact</small>
                <br/>
                <label class="form-check-label" for="acron"><strong>acronym: </strong></label>
                <input type="text" id="acron" name="acron[]" aria-describedby="acron-help"/>
                <small id="acron-help" class="text-muted">must be exact</small>
                <hr/>
            </div>
            <button class="btn btn-info" data-toggle="collapse" data-target="#product">
                product
            </button>
            <div id="product" class="collapse">
                <!--
                //https://datatables.net/reference/api/unique()
                //https://www.w3schools.com/TAGS/tryit.asp?filename=tryhtml_select_multiple
                -->
                <hr/>
                <label class="form-check-label" for="prod"><strong>id: </strong></label>
                <select id="prod" name="product[]">
                    <option value="5">5</option>
                    <option value="31">31</option>
                </select>
                <hr/>
            </div>
            <button class="btn btn-info" data-toggle="collapse" data-target="#injection">
                injection
            </button>
            <div id="injection" class="collapse">
                <hr/>
                <strong>volume: </strong>
                <label class="form-check-label" for="min-vol">min</label>
                <input type="text" id="min-vol" name="min-vol"/>
                <label class="form-check-label" for="max-vol">max</label>
                <input type="text" id="max-vol" name="max-vol"/>
                <br/>
                <strong><em>'x'</em> coordinate: </strong>
                <label class="form-check-label" for="min-x">min</label>
                <input type="text" id="min-x" name="min-x"/>
                <label class="form-check-label" for="max-x">max</label>
                <input type="text" id="max-x" name="max-x"/>
                <br/>
                <strong><em>'y'</em> coordinate: </strong>
                <label class="form-check-label" for="min-y">min</label>
                <input type="text" id="min-y" name="min-y"/>
                <label class="form-check-label" for="max-y">max</label>
                <input type="text" id="max-y" name="max-y"/>
                <br/>
                <strong><em>'z'</em> coordinate: </strong>
                <label class="form-check-label" for="min-z">min</label>
                <input type="text" id="min-z" name="min-z"/>
                <label class="form-check-label" for="max-z">max</label>
                <input type="text" id="max-z" name="max-z"/>
                <hr/>
            </div>

        </div>

        <hr style="border: 1px solid black"/>

        <h3>Columns visibility</h3>
        <div class="columns-vis">
            <div class="form-check form-check-inline">
                <input class="toggle-vis form-check-input" type="checkbox" data-column="0"
                       id="experiment-id" value="experiment-id" autocomplete="off" checked/>
                <label class="form-check-label" for="experiment-id">experiment id</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="toggle-vis form-check-input" type="checkbox" data-column="1"
                       id="hemisphere-name" value="hemisphere-name" autocomplete="off" checked/>
                <label class="form-check-label" for="hemisphere-name">hemisphere name</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="toggle-vis form-check-input" type="checkbox" data-column="2"
                       id="product-id" value="product-id" autocomplete="off" checked/>
                <label class="form-check-label" for="product-id">product id</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="toggle-vis form-check-input" type="checkbox" data-column="3"
                       id="injection-vol" value="injection-vol" autocomplete="off" checked/>
                <label class="form-check-label" for="injection-vol">injection vol.</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="toggle-vis form-check-input" type="checkbox" data-column="4"
                       id="injection-xyz" value="injection-xyz" autocomplete="off" checked/>
                <label class="form-check-label" for="injection-xyz">injection (x,y,z)</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="toggle-vis form-check-input" type="checkbox" data-column="5"
                       id="transgenic-line" value="transgenic-line" autocomplete="off" checked/>
                <label class="form-check-label" for="transgenic-line">transgenic line</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="toggle-vis form-check-input" type="checkbox" data-column="6"
                       id="gender" value="gender" autocomplete="off" checked/>
                <label class="form-check-label" for="gender">gender </label>
            </div>
            <div class="form-check form-check-inline">
                <input class="toggle-vis form-check-input" type="checkbox" data-column="7"
                       id="specimen-name" value="specimen-name" autocomplete="off" checked/>
                <label class="form-check-label" for="specimen-name">specimen name</label>
            </div>
        </div>

        <hr style="border: 1px solid black"/>

        <table id="experiments" class="datatable" cellspacing="0" width="100%">
            <!-- https://datatables.net/examples/api/show_hide.html -->
            <thead>
                <th>experiment id</th>
                <th>hemisphere name</th>
                <th>product id</th>
                <th>injection vol.</th>
                <th>injection (x,y,z)</th>
                <th>transgenic line</th>
                <th>gender</th>
                <th>specimen name</th>
            </thead>

            <tfoot>
                <th>experiment id</th>
                <th>hemisphere name</th>
                <th>product id</th>
                <th>injection vol.</th>
                <th>injection (x,y,z)</th>
                <th>transgenic line</th>
                <th>gender</th>
                <th>specimen name</th>
            </tfoot>

            <tbody>
                <!-- for each experiments -->
                {% for i in range(0, nb_exp) %}
                <tr>
                    <td>
                        <!-- get experiment id -->
                        {{ all_exp.iloc[i]['id'] }}
                    </td>
                    <td>
                        <!-- get hemisphere name -->
                        {{ all_exp.iloc[i]['structure_name'] }}
                        ({{ all_exp.iloc[i]['structure_abbrev'] }})
                    </td>
                    <td>
                        <!-- get product id -->
                        {{ all_exp.iloc[i]['product_id'] }}
                    </td>
                    <td>
                        <!-- get injection volume -->
                        {{ all_exp.iloc[i]['injection_volume'] }}
                    </td>
                    <td>
                        <!-- get injection coordinates -->
                        ({{ all_exp.iloc[i]['injection_x'] }},
                        {{ all_exp.iloc[i]['injection_y'] }},
                        {{ all_exp.iloc[i]['injection_z'] }})
                    </td>
                    <td>
                        <!-- get specimen name -->
                        {{ all_exp.iloc[i]['transgenic_line'] }}
                    </td>
                    <td>
                        <!-- get specimen gender -->
                        {{ all_exp.iloc[i]['gender'] }}
                    </td>
                    <td>
                        <!-- get specimen name -->
                        {{ all_exp.iloc[i]['specimen_name'] }}
                    </td>

                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
{% endblock %}

{% block dependenciesScripts %}
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="//cdn.datatables.net/1.10.20/js/jquery.dataTables.min.js"></script>
    <script src="{{ url_for('static', filename='js/table.js') }}"></script>

    <script type="text/javascript">
        $(document).ready(function ()
        {
            // columns visibilty in datatable
            $('.toggle-vis').on('click', function(e)
            {
                // Get the column API object
                var column = table.column($(this).attr('data-column'));

                // Toggle the visibility
                column.visible(! column.visible());
            });

            // Event listener to the two range filtering inputs to redraw on input
            $('#name, #acron' +
              '#min-vol, #max-vol,' +
              '#min-x, #max-x,' +
              '#min-y, #max-y,' +
              '#min-z, #max-z').keyup(function()
            {
                table.draw();
            });
        });

        /* Custom filtering function which will search data each columns */
        $.fn.dataTable.ext.search.push(
            function(settings, data, dataIndex)
            {
                // hemisphere section (add array)
                var names = $('#name').val();
                var acronyms = $('#acron').val();
                var hemisphere = data[2];

                // injection volume
                var minVol = parseFloat($('#min-vol').val(), 10);
                var maxVol = parseFloat($('#max-vol').val(), 10);
                var volume = parseFloat(data[3]) || 0;

                // injection location
                var minX = parseInt($('#min-x').val(), 10);
                var maxX = parseInt($('#max-x').val(), 10);
                var minY = parseInt($('#min-y').val(), 10);
                var maxY = parseInt($('#max-y').val(), 10);
                var minZ = parseInt($('#min-z').val(), 10);
                var maxZ = parseInt($('#max-z').val(), 10);
                var location = parseParenthesesToArray(data[4]);
                var x = parseInt(location[0]);
                var y = parseInt(location[1]);
                var z = parseInt(location[2]);

                if
                (
                    (validateNames(hemisphere, names)) &&
                    (validateAcronyms(hemisphere, acronyms)) &&
                    (validateMinMax(volume, minVol, maxVol)) &&
                    (validateMinMax(x, minX, maxX)) &&
                    (validateMinMax(y, minY, maxY)) &&
                    (validateMinMax(z, minZ, maxZ))
                )
                {
                    return true;
                }
                return false;
            }
        );
    </script>
{% endblock %}